<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HedgeGuard Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation Plugin for the Beta Shading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <!-- Html2Canvas for downloading HTML elements -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Table Row Selection */
        .selected-row {
            background-color: #e0e7ff !important; /* Indigo 50 */
            border-left: 4px solid #4f46e5;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Global State & Logic -->
    <script>
        // --- Configuration ---
        let GLOBAL_DATA = null;
        let GLOBAL_RETURNS = null;
        let STRATEGY_DATA = null; 
        let STRESS_EVENTS = null; 
        let INITIAL_INVESTMENT = 100000;
        let STATIC_RATIO = 1.0;
        let SELECTED_STRESS_INDEX = null;
        
        let charts = {};

        // --- 1. Math & Data Parsing ---

        // Robust CSV line parser to handle quoted fields with commas
        const parseCSVLine = (line) => {
            const result = [];
            let cur = "";
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(cur.trim());
                    cur = "";
                } else {
                    cur += char;
                }
            }
            result.push(cur.trim());
            return result;
        };

        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return null;
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                // Use robust parser instead of simple split
                const cols = parseCSVLine(lines[i]);
                if (cols.length < 3) continue;
                
                const dateParts = cols[0].split('/');
                if (dateParts.length !== 3) continue;
                
                const mm = dateParts[0].padStart(2, '0');
                const dd = dateParts[1].padStart(2, '0');
                let yy = parseInt(dateParts[2]);
                const yyyy = yy < 50 ? 2000 + yy : 1900 + yy;
                
                const isoString = `${yyyy}-${mm}-${dd}`;
                const dateObj = new Date(isoString);
                
                // Clean numeric values (remove quotes, dollar signs, and internal commas)
                const cleanNum = (val) => parseFloat(val.replace(/[",\$]/g, ''));
                const portfolioClose = cleanNum(cols[1]);
                const hedgeClose = cleanNum(cols[2]);

                if (!isNaN(portfolioClose) && !isNaN(hedgeClose) && !isNaN(dateObj.getTime())) {
                    data.push({
                        date: dateObj,
                        dateStr: cols[0], 
                        portfolio: portfolioClose,
                        hedge: hedgeClose
                    });
                }
            }
            return data.sort((a, b) => a.date - b.date);
        };

        const calculateReturns = (data) => {
            const returns = [];
            for (let i = 1; i < data.length; i++) {
                const today = data[i];
                const prev = data[i-1];
                
                // Explicitly check for finite, positive prices to avoid NaNs or infinite returns
                const p_curr = today.portfolio;
                const h_curr = today.hedge;
                const p_prev = prev.portfolio;
                const h_prev = prev.hedge;

                if (!Number.isFinite(p_curr) || p_curr <= 0 || !Number.isFinite(h_curr) || h_curr <= 0 ||
                    !Number.isFinite(p_prev) || p_prev <= 0 || !Number.isFinite(h_prev) || h_prev <= 0) {
                    continue;
                }
                
                const rPort = (p_curr - p_prev) / p_prev;
                const rHedge = (h_curr - h_prev) / h_prev;
                
                // Only push if results are valid numbers
                if (Number.isFinite(rPort) && Number.isFinite(rHedge)) {
                    returns.push({
                        date: today.date,
                        dateStr: today.dateStr,
                        rPort,
                        rHedge
                    });
                }
            }
            return returns;
        };

        const calculateRollingBeta = (returns, windowSize = 60) => {
            const betas = new Array(returns.length).fill(null);
            
            // Beta Warmup: Indices < windowSize remain null to avoid lookahead bias.
            for (let i = windowSize; i < returns.length; i++) {
                const windowData = returns.slice(i - windowSize, i);
                
                const meanPort = windowData.reduce((sum, d) => sum + d.rPort, 0) / windowSize;
                const meanHedge = windowData.reduce((sum, d) => sum + d.rHedge, 0) / windowSize;
                
                let cov = 0;
                let varHedge = 0;
                windowData.forEach(d => {
                    cov += (d.rPort - meanPort) * (d.rHedge - meanHedge);
                    varHedge += (d.rHedge - meanHedge) ** 2;
                });
                
                betas[i] = varHedge === 0 ? 0 : cov / varHedge;
            }
            return betas;
        };

        const calculateStrategyPerformance = (returns, rollingBetas, staticRatio, initialInvestment) => {
            let navUnhedged = initialInvestment;
            let navStatic = initialInvestment;
            let navDynamic = initialInvestment;
            
            let peakUnhedged = initialInvestment;
            let peakStatic = initialInvestment;
            let peakDynamic = initialInvestment;

            return returns.map((day, idx) => {
                const rUnhedged = day.rPort;
                const rStatic = day.rPort - (staticRatio * day.rHedge);
                
                // Dynamic Alignment: rollingBetas[idx] uses information strictly available as of idx-1.
                // During warmup period (idx < 60), dynamic hedge acts as unhedged.
                const dailyBeta = rollingBetas[idx];
                const rDynamic = dailyBeta === null ? rUnhedged : day.rPort - (dailyBeta * day.rHedge);

                navUnhedged *= (1 + rUnhedged);
                navStatic *= (1 + rStatic);
                navDynamic *= (1 + rDynamic);

                peakUnhedged = Math.max(peakUnhedged, navUnhedged);
                peakStatic = Math.max(peakStatic, navStatic);
                peakDynamic = Math.max(peakDynamic, navDynamic);

                return {
                    date: day.date,
                    displayDate: day.date.toLocaleDateString(),
                    unhedged: parseFloat(navUnhedged.toFixed(2)),
                    static: parseFloat(navStatic.toFixed(2)),
                    dynamic: parseFloat(navDynamic.toFixed(2)),
                    ddUnhedged: (navUnhedged / peakUnhedged) - 1,
                    ddStatic: (navStatic / peakStatic) - 1,
                    ddDynamic: (navDynamic / peakDynamic) - 1,
                    rUnhedged, rStatic, rDynamic,
                    originalIndex: idx 
                };
            });
        };

        const calculateKPIs = (strategyData, initialInvestment) => {
            const computeFor = (key, rKey) => {
                const n = strategyData.length;
                if (n <= 1) return { ret: '0%', vol: '0%', sharpe: '0.00', dd: '0%' };
                
                const totalReturn = (strategyData[n-1][key] / initialInvestment) - 1;
                const annReturn = Math.pow(1 + totalReturn, 252/n) - 1;
                
                const meanR = strategyData.reduce((s, d) => s + d[rKey], 0) / n;
                const variance = strategyData.reduce((s, d) => s + (d[rKey] - meanR)**2, 0) / (n - 1);
                const annVol = Math.sqrt(variance) * Math.sqrt(252);
                
                const maxDD = Math.min(...strategyData.map(d => d[`dd${key.charAt(0).toUpperCase() + key.slice(1)}`]));

                return {
                    ret: (annReturn * 100).toFixed(1) + '%',
                    retVal: annReturn * 100,
                    vol: (annVol * 100).toFixed(1) + '%',
                    volVal: annVol * 100,
                    sharpe: (annVol === 0 ? 0 : annReturn / annVol).toFixed(2),
                    dd: (maxDD * 100).toFixed(1) + '%',
                    ddVal: maxDD * 100
                };
            };

            return {
                unhedged: computeFor('unhedged', 'rUnhedged'),
                static: computeFor('static', 'rStatic'),
                dynamic: computeFor('dynamic', 'rDynamic')
            };
        };

        const getStressEvents = (strategyData) => {
            return [...strategyData]
                .sort((a, b) => a.rUnhedged - b.rUnhedged)
                .slice(0, 5);
        };

        const getMonthlyReturns = (returns) => {
            const monthsMap = {}; 
            returns.forEach(r => {
                const k = `${r.date.getFullYear()}-${String(r.date.getMonth()+1).padStart(2, '0')}`;
                if (!monthsMap[k]) monthsMap[k] = 1.0;
                monthsMap[k] *= (1 + r.rPort);
            });
            const pivot = {};
            Object.entries(monthsMap).forEach(([k, v]) => {
                const [y, m] = k.split('-');
                if (!pivot[y]) pivot[y] = Array(12).fill(null);
                pivot[y][parseInt(m)-1] = (v - 1) * 100;
            });
            return pivot;
        };

        const getMonthlyBoxPlotData = (returns) => {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const calendarMonthly = {}; 
            returns.forEach(r => {
                const key = `${r.date.getFullYear()}-${r.date.getMonth()}`;
                if (calendarMonthly[key] === undefined) calendarMonthly[key] = 1.0;
                calendarMonthly[key] *= (1 + r.rPort);
            });
            const groupedByMonthIndex = {}; 
            Object.entries(calendarMonthly).forEach(([key, val]) => {
                const mIndex = key.split('-')[1];
                if (!groupedByMonthIndex[mIndex]) groupedByMonthIndex[mIndex] = [];
                groupedByMonthIndex[mIndex].push((val - 1) * 100);
            });
            const quantile = (arr, q) => {
                const sorted = [...arr].sort((a, b) => a - b);
                const pos = (sorted.length - 1) * q;
                const base = Math.floor(pos);
                const rest = pos - base;
                if (sorted[base + 1] !== undefined) {
                    return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
                } else {
                    return sorted[base];
                }
            };
            return Object.entries(groupedByMonthIndex).map(([mIdx, vals]) => {
                const sorted = [...vals].sort((a, b) => a - b);
                return {
                    month: monthNames[parseInt(mIdx)],
                    min: sorted[0],
                    max: sorted[sorted.length - 1],
                    q1: quantile(sorted, 0.25),
                    median: quantile(sorted, 0.5),
                    q3: quantile(sorted, 0.75)
                };
            }).sort((a, b) => monthNames.indexOf(a.month) - monthNames.indexOf(b.month));
        };

        const getHistogramData = (returns) => {
            const values = returns.map(r => r.rPort * 100);
            if (values.length === 0) return [];
            const min = Math.floor(Math.min(...values));
            const max = Math.ceil(Math.max(...values));
            const binSize = 0.5;
            const bins = {};
            for (let i = min; i <= max; i += binSize) bins[i.toFixed(1)] = 0;
            values.forEach(v => {
                const binKey = (Math.floor(v / binSize) * binSize).toFixed(1);
                if (bins[binKey] !== undefined) bins[binKey]++;
            });
            return Object.entries(bins).map(([range, count]) => ({ range, count, val: parseFloat(range) })).sort((a, b) => a.val - b.val);
        };

        function downloadChart(canvasId, fileName) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = fileName + '.png';
            const ctx = canvas.getContext('2d');
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            link.href = canvas.toDataURL('image/png');
            link.click();
            ctx.restore();
        }

        function downloadElement(elementId, fileName) {
            const element = document.getElementById(elementId);
            if (!element) return;
            html2canvas(element, { backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = fileName + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function resetApp() {
            GLOBAL_DATA = null;
            GLOBAL_RETURNS = null;
            STRATEGY_DATA = null;
            STRESS_EVENTS = null;
            SELECTED_STRESS_INDEX = null;
            Object.keys(charts).forEach(key => {
                if (charts[key]) charts[key].destroy();
            });
            charts = {};
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-investment').classList.add('hidden');
            document.getElementById('view-upload').classList.remove('hidden');
            document.getElementById('csvFile').value = '';
            document.getElementById('investInput').value = 100000;
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });
    </script>

    <!-- VIEWS -->

    <!-- 1. Upload View -->
    <div id="view-upload" class="flex flex-col items-center justify-center min-h-screen">
        <div class="p-10 bg-white shadow-xl rounded-2xl text-center max-w-lg w-full border border-slate-200">
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Upload Data File</h1>
            <p class="text-slate-500 mb-8">Upload your CSV containing <strong>Date</strong>, <strong>Portfolio Close</strong>, and <strong>Hedge Close</strong>.</p>
            <label class="block w-full cursor-pointer group">
                <input type="file" id="csvFile" class="hidden" accept=".csv" />
                <div class="flex items-center justify-center w-full py-4 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium shadow-md shadow-indigo-200">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> Select CSV File
                </div>
            </label>
            <p class="mt-4 text-xs text-slate-400">Supported formats: CSV. Auto-detection enabled.</p>
        </div>
    </div>

    <!-- 2. Investment View -->
    <div id="view-investment" class="hidden flex flex-col items-center justify-center min-h-screen">
        <div class="p-10 bg-white shadow-xl rounded-2xl text-center max-w-lg w-full border border-slate-200">
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Initial Investment</h1>
            <p class="text-slate-500 mb-8">How much capital would you like to simulate?</p>
            <div class="mb-6 relative">
                <span class="absolute left-4 top-3 text-slate-400">$</span>
                <input type="number" id="investInput" value="100000" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition font-mono text-lg" />
            </div>
            <button onclick="startDashboard()" class="w-full py-4 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium shadow-md shadow-indigo-200 flex items-center justify-center gap-2">
                Start Analysis <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- 3. Dashboard View -->
    <div id="view-dashboard" class="hidden min-h-screen pb-20">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="shield" class="w-6 h-6 text-indigo-600"></i>
                    <h1 class="text-xl font-bold text-slate-800">HedgeGuard <span class="font-light text-slate-400">Analytics</span></h1>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-sm text-slate-500 hidden md:flex items-center gap-4">
                        <span>Investment: <strong id="display-invest"></strong></span>
                        <span class="h-4 w-px bg-slate-300"></span>
                        <span id="display-days"></span>
                    </div>
                    <button onclick="resetApp()" class="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-lg transition border border-slate-200">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        New Upload
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
            
            <!-- Section 1: Portfolio DNA -->
            <section class="space-y-6">
                <div class="flex items-center gap-2 mb-4">
                    <i data-lucide="activity" class="w-5 h-5 text-indigo-500"></i>
                    <h2 class="text-lg font-bold text-slate-800">Portfolio DNA (Unhedged)</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Monthly Heatmap -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-semibold text-slate-500">Monthly Return Matrix</h3>
                            <button onclick="downloadElement('heatmap-container', 'Monthly_Heatmap')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Image">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="heatmap-container" class="overflow-x-auto bg-white p-2"></div>
                    </div>

                    <!-- Monthly Box Plot -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-semibold text-slate-500">Seasonality: Compounded Monthly Returns</h3>
                            <button onclick="downloadChart('chartDispersion', 'Monthly_Dispersion')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Chart">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="h-64 chart-container">
                            <canvas id="chartDispersion"></canvas>
                        </div>
                    </div>

                    <!-- Histogram -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-semibold text-slate-500">Daily Return Histogram (Fat Tails)</h3>
                            <button onclick="downloadChart('chartHistogram', 'Daily_Histogram')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Chart">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="h-64 chart-container">
                            <canvas id="chartHistogram"></canvas>
                        </div>
                    </div>

                    <!-- 90-Day Rolling Beta -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-semibold text-slate-500">90-Day Rolling Beta</h3>
                            <button onclick="downloadChart('chartBeta', 'Rolling_Beta')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Chart">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="h-64 chart-container">
                            <canvas id="chartBeta"></canvas>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Section 2: Strategy Lab -->
            <section id="strategy-lab" class="space-y-6 pt-8 border-t border-slate-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-indigo-500"></i>
                        <h2 class="text-lg font-bold text-slate-800">Strategy Lab</h2>
                    </div>
                    
                    <div class="bg-white px-4 py-2 flex items-center gap-4 shadow-sm border border-indigo-100 rounded-lg">
                        <span class="text-sm font-medium text-slate-600 flex items-center gap-2">
                            <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i> Static Hedge Ratio:
                        </span>
                        <input type="range" id="ratioSlider" min="0.0" max="2.0" step="0.05" value="1.0" class="w-32 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                        <span id="ratioDisplay" class="text-sm font-bold text-indigo-600 w-12 text-right">1.00x</span>
                    </div>
                </div>

                <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex flex-col gap-1">
                    <div class="flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-indigo-600 mt-0.5 flex-shrink-0"></i>
                        <div id="dynamicInsight" class="text-sm text-indigo-900"></div>
                    </div>
                    <!-- Small UI Note regarding beta warmup -->
                    <div class="text-[10px] text-indigo-400 pl-8 italic">
                        Note: Dynamic hedge starts after 60 trading days (beta warmup). Until then it matches Unhedged.
                    </div>
                </div>

                <div class="bg-white p-6 h-[400px] rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-semibold text-slate-500">Cumulative Growth</h3>
                        <button onclick="downloadChart('chartPerformance', 'Cumulative_Growth')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Chart">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="chartPerformance"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <h3 class="text-sm font-semibold text-slate-500">Drawdown Analysis (Faceted)</h3>
                            <div class="flex gap-3 text-xs flex-wrap">
                                <span class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-200 rounded-sm"></div> Risk Shadow</span>
                                <span class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-sm"></div> Static</span>
                                <span class="flex items-center gap-1"><div class="w-3 h-3 bg-purple-500 rounded-sm"></div> Dynamic</span>
                            </div>
                        </div>
                        <button onclick="downloadElement('drawdown-container', 'Drawdown_Analysis')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download All Panels">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div id="drawdown-container" class="flex flex-col gap-4 h-[500px] bg-white p-1">
                        <div class="relative flex-1 bg-slate-50/50 rounded border border-slate-100 group">
                            <div class="absolute top-2 left-2 text-[10px] font-bold text-slate-400 bg-white px-1 rounded shadow-sm z-10 flex items-center gap-2">
                                BASELINE RISK
                                <button onclick="downloadChart('ddChart1', 'DD_Baseline')" class="hover:text-indigo-600 transition"><i data-lucide="download" class="w-3 h-3"></i></button>
                            </div>
                            <canvas id="ddChart1"></canvas>
                        </div>
                        <div class="relative flex-1 bg-slate-50/50 rounded border border-slate-100 group">
                            <div class="absolute top-2 left-2 text-[10px] font-bold text-green-600 bg-white px-1 rounded shadow-sm z-10 flex items-center gap-2">
                                STATIC HEDGE
                                <button onclick="downloadChart('ddChart2', 'DD_Static')" class="hover:text-green-700 transition"><i data-lucide="download" class="w-3 h-3"></i></button>
                            </div>
                            <canvas id="ddChart2"></canvas>
                        </div>
                        <div class="relative flex-1 bg-slate-50/50 rounded border border-slate-100 group">
                            <div class="absolute top-2 left-2 text-[10px] font-bold text-purple-600 bg-white px-1 rounded shadow-sm z-10 flex items-center gap-2">
                                DYNAMIC HEDGE
                                <button onclick="downloadChart('ddChart3', 'DD_Dynamic')" class="hover:text-purple-700 transition"><i data-lucide="download" class="w-3 h-3"></i></button>
                            </div>
                            <canvas id="ddChart3"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 3: Stress Tests -->
            <section class="pt-8 border-t border-slate-200">
                <div class="flex items-center gap-2 mb-6">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i>
                    <h2 class="text-lg font-bold text-slate-800">Stress Test: Worst 5 Days</h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-100">
                            <span class="text-xs font-semibold text-slate-500 uppercase">Click a row to analyze event</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th class="p-4">Date</th>
                                        <th class="p-4">Unhedged Return</th>
                                        <th class="p-4">Hedge Impact</th>
                                        <th class="p-4">Static Result</th>
                                        <th class="p-4">Dynamic Result</th>
                                    </tr>
                                </thead>
                                <tbody id="stress-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="lg:col-span-1 bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-semibold text-slate-500">Event Replay (+/- 10 Days)</h3>
                            <button onclick="downloadChart('chartDrillDown', 'Event_Replay')" class="p-1 text-slate-400 hover:text-indigo-600 transition" title="Download Chart">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="drill-chart-container" class="flex-1 h-48 relative">
                            <div id="drill-empty" class="absolute inset-0 flex items-center justify-center text-slate-400 text-xs text-center p-8 border-2 border-dashed border-slate-100 rounded-lg">
                                Select a crash event from the table to see how the hedge performed before and after the shock.
                            </div>
                            <canvas id="chartDrillDown" class="hidden"></canvas>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MAIN APP LOGIC -->
    <script>
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const parsed = parseCSV(evt.target.result);
                if (parsed && parsed.length > 0) {
                    GLOBAL_DATA = parsed;
                    GLOBAL_RETURNS = calculateReturns(parsed);
                    document.getElementById('view-upload').classList.add('hidden');
                    document.getElementById('view-investment').classList.remove('hidden');
                } else {
                    alert('Invalid CSV format. Ensure Date, Portfolio, and Hedge columns exist.');
                }
            };
            reader.readAsText(file);
        });

        function startDashboard() {
            INITIAL_INVESTMENT = parseFloat(document.getElementById('investInput').value) || 100000;
            document.getElementById('view-investment').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            
            document.getElementById('display-invest').textContent = `$${INITIAL_INVESTMENT.toLocaleString()}`;
            document.getElementById('display-days').textContent = `${GLOBAL_DATA.length} days`;
            
            renderStaticVisuals();
            updateStrategy(1.0);
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        document.getElementById('ratioSlider').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('ratioDisplay').textContent = val.toFixed(2) + 'x';
            updateStrategy(val);
        });

        function renderStaticVisuals() {
            renderHeatmap();
            renderDispersionChart();
            renderHistogramChart();
            renderBetaChart();
        }

        function renderHeatmap() {
            const monthly = getMonthlyReturns(GLOBAL_RETURNS);
            const years = Object.keys(monthly).sort();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            
            let html = `<table class="w-full text-xs text-center border-collapse"><thead><tr><th class="p-2 text-left text-slate-400 font-medium">Year</th>`;
            months.forEach(m => html += `<th class="p-2 text-slate-400 font-medium">${m}</th>`);
            html += `</tr></thead><tbody>`;

            years.forEach(year => {
                html += `<tr class="border-t border-slate-100 hover:bg-slate-50"><td class="p-2 text-left font-bold text-slate-600">${year}</td>`;
                monthly[year].forEach(val => {
                    let color = "bg-slate-50 text-slate-300";
                    let text = "-";
                    if (val !== null) {
                        text = val.toFixed(1) + '%';
                        if (val > 5) color = "bg-emerald-500 text-white";
                        else if (val > 2) color = "bg-emerald-400 text-white";
                        else if (val > 0) color = "bg-emerald-200 text-emerald-900";
                        else if (val > -2) color = "bg-rose-200 text-rose-900";
                        else if (val > -5) color = "bg-rose-400 text-white";
                        else color = "bg-rose-600 text-white";
                    }
                    html += `<td class="p-1"><div class="w-full h-8 flex items-center justify-center rounded ${color}">${text}</div></td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('heatmap-container').innerHTML = html;
        }

        function renderDispersionChart() {
            const data = getMonthlyBoxPlotData(GLOBAL_RETURNS);
            const ctx = document.getElementById('chartDispersion').getContext('2d');
            if(charts.dispersion) charts.dispersion.destroy();
            charts.dispersion = new Chart(ctx, {
                data: {
                    labels: data.map(d => d.month),
                    datasets: [
                        {
                            type: 'bar',
                            label: 'IQR (Q1-Q3)',
                            data: data.map(d => [d.q1, d.q3]),
                            backgroundColor: '#94a3b8',
                            barPercentage: 0.5,
                            borderRadius: 2,
                            order: 2
                        },
                        {
                            type: 'scatter',
                            label: 'Median',
                            data: data.map(d => d.median),
                            backgroundColor: '#312e81',
                            pointStyle: 'rectRot',
                            pointRadius: 5,
                            order: 1
                        },
                        {
                            type: 'scatter',
                            label: 'Extreme Gain (Max)',
                            data: data.map(d => d.max),
                            backgroundColor: '#10b981',
                            pointStyle: 'circle',
                            pointRadius: 4,
                            order: 1
                        },
                        {
                            type: 'scatter',
                            label: 'Extreme Loss (Min)',
                            data: data.map(d => d.min),
                            backgroundColor: '#f43f5e',
                            pointStyle: 'circle',
                            pointRadius: 4,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => {
                                    if(ctx.dataset.type === 'bar') return `IQR: ${ctx.raw[0].toFixed(1)}% to ${ctx.raw[1].toFixed(1)}%`;
                                    return `${ctx.dataset.label}: ${ctx.raw.toFixed(2)}%`;
                                } 
                            } 
                        } 
                    },
                    scales: { 
                        y: { title: { display: true, text: 'Monthly Return (%)', font: {size: 10} }, ticks: { callback: v => v + '%' } }, 
                        x: { grid: { display: false } } 
                    },
                    layout: { padding: { bottom: 20 } }
                }
            });
        }

        function renderHistogramChart() {
            const data = getHistogramData(GLOBAL_RETURNS);
            const ctx = document.getElementById('chartHistogram').getContext('2d');
            if(charts.histogram) charts.histogram.destroy();
            charts.histogram = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.range),
                    datasets: [{
                        label: 'Frequency',
                        data: data.map(d => d.count),
                        backgroundColor: '#6366f1',
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: true, font: {size: 10} }, grid: { display: false } } 
                    },
                    plugins: { legend: { display: false } },
                    layout: { padding: { bottom: 20 } }
                }
            });
        }

        function renderBetaChart() {
            const betas = calculateRollingBeta(GLOBAL_RETURNS, 90);
            const slicedBetas = betas.slice(90);
            const labels = GLOBAL_RETURNS.map(r => r.dateStr).slice(90);
            const ctx = document.getElementById('chartBeta').getContext('2d');
            
            // Edge-case safety for maxBeta calculation
            const validBetas = slicedBetas.filter(b => b !== null);
            const maxBeta = validBetas.length > 0 ? Math.max(...validBetas) : 2.0;

            if(charts.beta) charts.beta.destroy();
            charts.beta = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '90-Day Rolling Beta',
                        data: slicedBetas,
                        borderColor: '#334155',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        spanGaps: false 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                highBetaZone: {
                                    type: 'box',
                                    yMin: 1.2,
                                    yMax: maxBeta * 1.05,
                                    backgroundColor: 'rgba(244, 63, 94, 0.1)',
                                    borderWidth: 0,
                                    label: { content: 'High Beta Zone (>1.2)', display: true, position: 'start', color: '#ef4444', font: { size: 10 } }
                                },
                                line1: {
                                    type: 'line',
                                    yMin: 1.2, yMax: 1.2,
                                    borderColor: '#ef4444', borderWidth: 1, borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { maxTicksLimit: 10, maxRotation: 0 } }, 
                        y: { title: { display: true, text: 'Beta to Hedge' } }
                    },
                    layout: { padding: { bottom: 20 } }
                }
            });
        }

        function updateStrategy(ratio) {
            STATIC_RATIO = ratio;
            const rollingBetas = calculateRollingBeta(GLOBAL_RETURNS, 60);
            STRATEGY_DATA = calculateStrategyPerformance(GLOBAL_RETURNS, rollingBetas, ratio, INITIAL_INVESTMENT);
            STRESS_EVENTS = getStressEvents(STRATEGY_DATA);
            const kpis = calculateKPIs(STRATEGY_DATA, INITIAL_INVESTMENT);
            
            updateKPICards(kpis, ratio);
            renderPerformanceChart(STRATEGY_DATA);
            renderDrawdownChart(STRATEGY_DATA);
            renderStressTable();
            
            if (SELECTED_STRESS_INDEX !== null) renderDrillDown(SELECTED_STRESS_INDEX);
            
            const volReduction = (1 - (kpis.static.volVal / kpis.unhedged.volVal)) * 100;
            const returnCost = (kpis.unhedged.retVal - kpis.static.retVal);
            document.getElementById('dynamicInsight').innerHTML = `
                <strong>Insight:</strong> At <strong>${ratio.toFixed(2)}x</strong> ratio, static hedge 
                reduces volatility by <span class="font-bold">${volReduction.toFixed(1)}%</span>. 
                "Cost": <strong>${returnCost.toFixed(1)}%</strong> in ann. returns.
                ${kpis.static.ddVal > -15 ? "Excellent protection." : "Drawdown still significant."}
            `;
        }

        function updateKPICards(kpis, ratio) {
            const container = document.getElementById('kpi-container');
            const makeCard = (title, data, highlight) => `
                <div class="p-6 rounded-xl border shadow-sm transition-all hover:-translate-y-0.5 ${highlight ? 'border-indigo-200 bg-indigo-50/30' : 'bg-white border-slate-200'}">
                    <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                        ${title} ${highlight ? '<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">Active</span>' : ''}
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-baseline">
                            <span class="text-slate-600 text-sm">Ann. Return</span>
                            <span class="text-xl font-bold ${parseFloat(data.ret) >= 0 ? 'text-emerald-600' : 'text-red-600'}">${data.ret}</span>
                        </div>
                        <div class="flex justify-between items-baseline">
                            <span class="text-slate-600 text-sm">Max Drawdown</span>
                            <span class="text-xl font-bold text-rose-600">${data.dd}</span>
                        </div>
                        <div class="pt-3 border-t border-slate-100 grid grid-cols-2 gap-4">
                            <div><span class="block text-xs text-slate-400 mb-1">Volatility</span><span class="font-semibold text-slate-700">${data.vol}</span></div>
                            <div class="text-right">
                                <span class="block text-xs text-slate-400 mb-1">Sharpe (rf=0)</span>
                                <span class="font-semibold text-slate-700">${data.sharpe}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = 
                makeCard("Unhedged (QQQ)", kpis.unhedged, false) +
                makeCard(`Static Hedge (${ratio.toFixed(2)}x)`, kpis.static, true) +
                makeCard("Dynamic Hedge (Beta)", kpis.dynamic, false);
        }

        function renderPerformanceChart(data) {
            if (charts.perf) charts.perf.destroy();
            const ctx = document.getElementById('chartPerformance').getContext('2d');
            const step = Math.ceil(data.length / 500); 
            const d = data.filter((_, i) => i % step === 0);
            charts.perf = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.map(x => x.displayDate),
                    datasets: [
                        { label: 'Unhedged', data: d.map(x => x.unhedged), borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: `Static (${STATIC_RATIO}x)`, data: d.map(x => x.static), borderColor: '#10b981', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: 'Dynamic (Beta)', data: d.map(x => x.dynamic), borderColor: '#8b5cf6', borderWidth: 2, borderDash: [5,5], pointRadius: 0, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { y: { ticks: { callback: v => '$' + v.toLocaleString() } }, x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } } },
                    layout: { padding: { bottom: 20 } }
                }
            });
        }

        function renderDrawdownChart(data) {
            if (charts.dd1) charts.dd1.destroy();
            if (charts.dd2) charts.dd2.destroy();
            if (charts.dd3) charts.dd3.destroy();
            const step = Math.ceil(data.length / 500);
            const d = data.filter((_, i) => i % step === 0);
            const commonOptions = {
                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                elements: { point: { radius: 0, hitRadius: 10 } }, layout: { padding: { left: 0, right: 10, top: 5, bottom: 5 } }
            };
            const allValues = [...d.map(x => x.ddUnhedged * 100), ...d.map(x => x.ddStatic * 100), ...d.map(x => x.ddDynamic * 100)];
            const minVal = Math.min(...allValues);
            const yAxisConfig = { min: minVal, max: 0, ticks: { callback: v => v + '%', font: {size: 9}, maxTicksLimit: 4 }, grid: { drawBorder: false } };

            charts.dd1 = new Chart(document.getElementById('ddChart1').getContext('2d'), {
                type: 'line',
                data: { labels: d.map(x => x.displayDate), datasets: [{ data: d.map(x => x.ddUnhedged * 100), borderColor: 'transparent', backgroundColor: '#e2e8f0', fill: true, borderWidth: 0 }] },
                options: { ...commonOptions, scales: { x: { display: false }, y: yAxisConfig } }
            });

            charts.dd2 = new Chart(document.getElementById('ddChart2').getContext('2d'), {
                type: 'line',
                data: { labels: d.map(x => x.displayDate), datasets: [{ data: d.map(x => x.ddUnhedged * 100), borderColor: 'transparent', backgroundColor: '#e2e8f0', fill: true, borderWidth: 0, pointRadius: 0 }, { data: d.map(x => x.ddStatic * 100), borderColor: '#10b981', borderWidth: 2, fill: false }] },
                options: { ...commonOptions, scales: { x: { display: false }, y: yAxisConfig } }
            });

            charts.dd3 = new Chart(document.getElementById('ddChart3').getContext('2d'), {
                type: 'line',
                data: { labels: d.map(x => x.displayDate), datasets: [{ data: d.map(x => x.ddUnhedged * 100), borderColor: 'transparent', backgroundColor: '#e2e8f0', fill: true, borderWidth: 0, pointRadius: 0 }, { data: d.map(x => x.ddDynamic * 100), borderColor: '#8b5cf6', borderWidth: 2, fill: false }] },
                options: { ...commonOptions, scales: { x: { ticks: { maxTicksLimit: 6, maxRotation: 0, autoSkip: true, font: {size: 10} }, grid: { display: false } }, y: yAxisConfig }, layout: { padding: { bottom: 10, right: 10 } } }
            });
        }

        function renderStressTable() {
            const tbody = document.getElementById('stress-table-body');
            tbody.innerHTML = '';
            STRESS_EVENTS.forEach((day, i) => {
                const saved = day.rStatic - day.rUnhedged;
                const tr = document.createElement('tr');
                tr.className = `cursor-pointer transition hover:bg-slate-50 border-b border-slate-50 ${SELECTED_STRESS_INDEX === day.originalIndex ? 'selected-row' : ''}`;
                tr.onclick = () => renderDrillDown(day.originalIndex);
                tr.innerHTML = `
                    <td class="p-4 font-mono text-slate-600">${day.displayDate}</td>
                    <td class="p-4 text-rose-600 font-bold">${(day.rUnhedged * 100).toFixed(2)}%</td>
                    <td class="p-4 text-emerald-600">+${(saved * 100).toFixed(2)}%</td>
                    <td class="p-4 font-bold ${day.rStatic >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${(day.rStatic * 100).toFixed(2)}%</td>
                    <td class="p-4 ${day.rDynamic >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${(day.rDynamic * 100).toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDrillDown(originalIndex) {
            SELECTED_STRESS_INDEX = originalIndex;
            renderStressTable();
            document.getElementById('drill-empty').classList.add('hidden');
            document.getElementById('chartDrillDown').classList.remove('hidden');
            const centerIdx = originalIndex;
            const start = Math.max(0, centerIdx - 10);
            const end = Math.min(STRATEGY_DATA.length, centerIdx + 11);
            const slice = STRATEGY_DATA.slice(start, end);
            const baseUnhedged = slice[0].unhedged;
            const baseStatic = slice[0].static;
            const baseDynamic = slice[0].dynamic;
            const rebased = slice.map(d => ({ displayDate: d.displayDate, unhedged: (d.unhedged / baseUnhedged) * 100, static: (d.static / baseStatic) * 100, dynamic: (d.dynamic / baseDynamic) * 100 }));
            if (charts.drill) charts.drill.destroy();
            charts.drill = new Chart(document.getElementById('chartDrillDown').getContext('2d'), {
                type: 'line',
                data: { labels: rebased.map(d => d.displayDate), datasets: [{ label: 'Unhedged', data: rebased.map(d => d.unhedged), borderColor: '#f43f5e', borderWidth: 2, pointRadius: 1 }, { label: 'Static', data: rebased.map(d => d.static), borderColor: '#10b981', borderWidth: 2, pointRadius: 1 }, { label: 'Dynamic', data: rebased.map(d => d.dynamic), borderColor: '#8b5cf6', borderWidth: 2, pointRadius: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { boxWidth: 10, font: {size: 10} } }, annotation: { annotations: { line1: { type: 'line', scaleID: 'x', value: STRATEGY_DATA[centerIdx].displayDate, borderColor: 'orange', borderWidth: 1, borderDash: [5, 5], label: { content: 'Crash Day', display: true, position: 'start', font: {size: 9} } } } } }, scales: { x: { ticks: { display: false } }, y: { ticks: { font: {size: 10} } } } }
            });
        }
    </script>
</body>
</html>
